{% extends "base.html" %}
{% load custom_filters %}

{% block title %}Drives{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
  <h1 class="text-3xl font-semibold mb-6">My Drives</h1>
  {% if show_preserved_only %}
    <a href="{% url 'drive_list' %}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Show All</a>
  {% else %}
    <a href="?preserved=1" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Show Preserved Only</a>
  {% endif %}

  {% if page_obj %}
    <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
      {% for drive in page_obj %}
        <a href="{% url 'drive_detail' drive.route_id %}" class="block">
          <div class="bg-white rounded-2xl shadow hover:shadow-lg transition p-5">
            <!-- Header -->
            <div class="flex justify-between items-center mb-3">
              <span class="text-lg font-medium text-gray-800 flex items-center gap-1">
                Route {{ drive.route_id }}
                <!-- Preserve star -->
                {% if drive.route_id in preserved_routes %}
                  <span class="text-yellow-500">â˜…</span>
                {% endif %}

                <!-- Copy button -->
                <button type="button"
                        onclick="event.stopPropagation(); event.preventDefault(); copyToClipboard('{{ drive.route_id|escapejs }}');"
                        class="ml-1 p-1 rounded hover:bg-gray-200"
                        title="Copy Route ID">
                  <!-- Clipboard icon -->
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500"
                      fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h6a2 2 0 012 2v2m0 4h2a2 2 0 012 2v6a2 2 0 01-2 2h-6a2 2 0 01-2-2v-2"/>
                  </svg>
                </button>
              </span>
              {% if drive.start_time.year == 1900 %}
                <span class="text-sm text-gray-400">No timestamp</span>
              {% else %}
                <span class="text-sm text-gray-500">{{ drive.start_time|date:"Y-m-d H:i" }}</span>
              {% endif %}
            </div>
            <form method="post" action="{% url 'toggle_preserve' drive.route_id %}" class="inline-block">
              {% csrf_token %}
              <button type="submit" class="p-1 rounded hover:bg-gray-200" title="{% if drive.route_id in preserved_routes %}Unsave{% else %}Save{% endif %}">
                {% if drive.route_id in preserved_routes %}
                  <!-- Filled star -->
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.963a1 1 0 00.95.69h4.17c.969 0 1.371 1.24.588 1.81l-3.374 2.454a1 1 0 00-.364 1.118l1.287 3.963c.3.922-.755 1.688-1.54 1.118l-3.374-2.454a1 1 0 00-1.176 0l-3.374 2.454c-.784.57-1.838-.196-1.539-1.118l1.287-3.963a1 1 0 00-.364-1.118L2.048 9.39c-.784-.57-.38-1.81.588-1.81h4.17a1 1 0 00.95-.69l1.286-3.963z" />
                  </svg>
                {% else %}
                  <!-- Blank star -->
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.963a1 1 0 00.95.69h4.17c.969 0 1.371 1.24.588 1.81l-3.374 2.454a1 1 0 00-.364 1.118l1.287 3.963c.3.922-.755 1.688-1.54 1.118l-3.374-2.454a1 1 0 00-1.176 0l-3.374 2.454c-.784.57-1.838-.196-1.539-1.118l1.287-3.963a1 1 0 00-.364-1.118L2.048 9.39c-.784-.57-.38-1.81.588-1.81h4.17a1 1 0 00.95-.69l1.286-3.963z" />
                  </svg>
                {% endif %}
              </button>
            </form>

            <!-- Thumbnails -->
            <div class="space-y-2">
              {% for cam in cameras %}
                <div>
                  <span class="font-medium text-gray-700">{{ cam|title }} Camera</span>
                  <div class="flex gap-2 mt-1">
                    {% for thumb in drive.thumbnails|dict_get:cam %}
                      {% if thumb|file_exists_relative_url %}
                        <img src="/media/{{ thumb }}" class="w-24 h-24 object-cover rounded-md" />
                      {% else %}
                        <div class="w-24 h-14 bg-gray-200 rounded-md shadow-sm flex items-center justify-center text-xs text-gray-400">
                          N/A
                        </div>
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            </div>

            <!-- Info -->
            <div class="text-gray-600 text-sm truncate">
              Stitched path: {{ drive.stitched_path }}
            </div>
          </div>
        </a>
      {% endfor %}
    </div>
    <div class="mt-6 flex justify-center space-x-2">
      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Previous</a>
      {% endif %}

      <span class="px-3 py-1 bg-gray-100 rounded">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Next</a>
      {% endif %}
    </div>
  {% else %}
    <p class="text-gray-500">No drives available.</p>
  {% endif %}
</div>
{% endblock %}
